<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebSocket Test</title>

  <script language="javascript" type="text/javascript" src="core.js" ></script>
  <script language="javascript" type="text/javascript" src="base64.js" ></script>
  <script language="javascript" type="text/javascript" src="resources.js" ></script>
  <script language="javascript" type="text/javascript" src="device.js" ></script>
  
  <script language="javascript" type="text/javascript" src="detect.js" ></script>
  
  <script language="javascript" type="text/javascript" src="flash/swfobject.js" ></script>
  <script language="javascript" type="text/javascript" src="flash/flash.js" ></script>
  
  <script language="javascript" type="text/javascript" src="websockets/registry.js" ></script>
  <script language="javascript" type="text/javascript" src="websockets/websockets.js" ></script>

  <script language="javascript" type="text/javascript">
    bm.start({
      
      name: "Websockets Test",
      maxPlayers: 1,
      
      appId:"62e822bc0e6b9f22fc158763591845be",
      swfURL: "swf/bin/brassmonkey.swf",

      minimumVersion: {major: 1, minor: 4},
      
      design: {
        orientation: "portrait",
        touchEnabled: false,
        accelerometerEnabled: false,
        preload:[],
        layout:[{
            type:   "image",
            src:    '../examples/shared/background.png',
            x:      0,
            y:      0,
            width:  320,
            height: 480
          }, {
            type:       "button",
            id:         "push",
            srcUp:      '../examples/buttons/button-up.png',
            srcDown:    '../examples/buttons/button-down.png',
            x:          (320-160)/2-3,
            y:          (480-160)/2,
            width:      160,
            height:     160
          }, {
            type:       "text",
            text:       "Hello",
            textSize:   25,
            color:      "FFFFFF",
            x:          0,
            y:          0,
            width:      320,
            height:     160
          },{
            type:       "image",
            src:        '../examples/buttons/button-up.png',
            x:          0,
            y:          0,
            width:      40,
            height:     40
          }, 
        ]
      }
    });

    bm.on('showslotcolor', function(e) {
      var slot = document.getElementById('slot');
      slot.style.background = e.color;
    });
    
    bm.on('buttondown', function(e){
      if(e.id="push"){
        var button = document.getElementById('button');
        button.style.background = "red";

        var controls = e.device.editDesign();
        controls.layout[0].hidden = true;
        controls.commit();
      }
    });
    bm.on('buttonup', function(e){
      if(e.id="push"){
        var button = document.getElementById('button');
        button.style.background = "#ffafaf";

        var controls = e.device.editDesign();
        controls.layout[0].hidden = false;
        controls.layout[2].color = "0000FF";
        controls.layout[2].x = controls.layout[2].x+10;
        controls.commit();
      }
    });

    var device;
    bm.on('deviceconnected', function (e){
      bm.log("device connected %o", e);
      
      device = e.device;
     //e.device.enableTouch(true);
     //e.device.setTouchInterval(1/60);

     bm.log("device gyro: %b, orientation: %b", e.device.hasCapability("gyroscope"), e.device.hasCapability("orientation"));
    });
    
    bm.on('acceleration', function (e){
      //bm.log(e);
    });
    
    var touches = {};
    bm.on('touchstart', function (e){
      var color = '#'+Math.floor(Math.random()*16777215).toString(16);
    
      drawContext.fillStyle=color;
      drawContext.fillRect(e.x-1,e.y-1,3,3);
    
      // Store the last position of a touch
      touches[e.id]={
        x:e.x,
        y:e.y,
        color: color
      };
    });

    bm.on('touchmove', function (e){
      drawContext.strokeStyle=touches[e.id].color;
      drawContext.beginPath();
      drawContext.moveTo(touches[e.id].x,touches[e.id].y);
      drawContext.lineTo(e.x,e.y);
      drawContext.stroke();
      
      // Update the last position
      touches[e.id]={x:e.x,y:e.y};
    });
    bm.on('touchend', function (e){
      // Delete the touch from our list of tracked ones
      delete touches[e.id]
    });


    /*bm.on('controlscheme', function(e) {
      var controls = e.device.editDesign();
      controls.layout[2].text = "hello, " + e.device.name;
      controls.commit();
    });*/
    
    function onload(){
      // Initialize canvas to black.      
      drawContext = document.getElementById('canvas').getContext('2d');
      drawContext.fillStyle="black";
      drawContext.fillRect(0,0,320,480);
      
      drawContext.lineWidth = 3;
      drawContext.lineCap = drawContext.lineJoin = "round";
    }


    bm.on('navstring', function (e){
      bm.log("nav string %s", e.string);
    });
    
    var testInterval;
    function testAnimation (){
      if(testInterval){
        clearInterval(testInterval);
        testInterval = null;
      }
      var vx = (Math.random()-0.5)*30,
          vy = (Math.random()-0.5)*30;
          
      // Make the image bounce around on the controller
      // like a ball
      testInterval = setInterval(function(){
        var controls = device.editDesign();
        controls.layout[3].x = controls.layout[3].x+vx;
        controls.layout[3].y = controls.layout[3].y+vy;
        
        // Bounce of walls
        if( controls.layout[3].x<0||
            controls.layout[3].x>(320-40)){
          vx=-vx;
        }
        if( controls.layout[3].y<0||
            controls.layout[3].y>(480-40)){
          vy=-vy;
        }
        
        controls.commit();
      },16);
    }

    
  </script>
</head>
<body style="margin:0px" onload="onload();">
  <div id="slot" style="padding-top: 30px;width:64px;height:64px;background:#000000;"></div>
  <div id="button" style="padding-top: 30px;width:64px;height:64px;background:#ffafaf;"></div>
  <canvas id="canvas" width="320px" height="480px"></canvas>

<br><br>
<input type="button" onClick="testAnimation();" value="Test Animation"/>
<h4>Set a Controller Mode</h4>
<ul>
<li><a href="javascript:void(0)" onClick="bm.allDevices().setMode('keyboard')"> keyboard </a></li>
<li><a href="javascript:void(0)" onClick="bm.allDevices().setMode('navigation')"> navigation </a></li>
<li><a href="javascript:void(0)" onClick="bm.allDevices().setMode('gamepad')"> gamepad </a></li>
<li><a href="javascript:void(0)" onClick="bm.allDevices().setMode('wait')"> wait </a></li>
</ul>


</body>
</html>